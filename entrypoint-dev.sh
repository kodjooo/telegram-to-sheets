#!/bin/bash

echo "=== –†–ï–ñ–ò–ú –†–ê–ó–†–ê–ë–û–¢–ö–ò ==="
echo "–ò–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"

# –ó–∞–ø—É—Å–∫ cron –¥–µ–º–æ–Ω–∞ (–≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Ç–æ–∂–µ –Ω—É–∂–µ–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á)
echo "–ó–∞–ø—É—Å–∫ cron –¥–µ–º–æ–Ω–∞..."
cron

# –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
echo "–¢–µ–∫—É—â–∏–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å: $(date)"
echo "Cron –∑–∞–¥–∞–Ω–∏—è:"
crontab -l

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
mkdir -p /app/logs
touch /app/logs/telegram_to_sheets.log
touch /app/logs/fetch_code_cron.log  
touch /app/logs/gpt_process.log
touch /app/logs/unknown_tx.log
touch /app/logs/daily_summary.log
touch /app/logs/dev.log

echo ""
echo "üöÄ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Telegram-to-Sheets –∑–∞–ø—É—â–µ–Ω–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏!"
echo "üìÇ –ö–æ–¥ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –∏–∑: ./app/"
echo "üìù –õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤: ./logs/"
echo ""
echo "üí° –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:"
echo "   - docker-compose -f docker-compose.dev.yml logs -f    # –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤"
echo "   - docker exec -it telegram-to-sheets-dev bash         # –í—Ö–æ–¥ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
echo "   - docker-compose -f docker-compose.dev.yml restart    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏"
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ñ–∞–π–ª–æ–≤ Python
watch_files() {
    echo "üëÄ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π Python —Ñ–∞–π–ª–æ–≤..."
    
    while true; do
        # –ú–æ–Ω–∏—Ç–æ—Ä–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Python —Ñ–∞–π–ª–∞—Ö
        inotifywait -r -e modify /app --include='.*\.py$' 2>/dev/null
        
        if [ $? -eq 0 ]; then
            echo "üîÑ $(date '+%Y-%m-%d %H:%M:%S') - –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Python —Ñ–∞–π–ª–∞—Ö" >> /app/logs/dev.log
            echo "üîÑ $(date '+%Y-%m-%d %H:%M:%S') - –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Python —Ñ–∞–π–ª–∞—Ö"
            
            # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≥–ª–∞–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
            # pkill -f telegram_to_sheets.py 2>/dev/null || true
        fi
        
        sleep 1
    done &
}

# –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ñ–∞–π–ª–æ–≤ –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω inotify-tools
if command -v inotifywait >/dev/null 2>&1; then
    watch_files
else
    echo "‚ö†Ô∏è  inotify-tools –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ"
    echo "   –î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: apt-get install inotify-tools"
fi

echo "üìã –ü–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ cron –∑–∞–¥–∞–Ω–∏—è:"
crontab -l

echo ""
echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ (Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏):"

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ª–æ–≥–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
tail -f /app/logs/telegram_to_sheets.log /app/logs/dev.log 2>/dev/null &

# –ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–æ–¥–æ–ª–∂–∞–ª —Ä–∞–±–æ—Ç–∞—Ç—å
wait
